ARCH-OS=x86-linux
MKDIR=mkdir -p
INSTALL=cp -p
KIT_FLAGS=

bootstrap:
	cd src; ../bin/mlkit -gc sources.pm
	$(MKDIR) $(INSTDIR)
	$(MKDIR) $(INSTDIR)/bin
	$(INSTALL) bin/runtimeSystem.o $(INSTDIR)/bin
	$(INSTALL) bin/runtimeSystemGC.o $(INSTDIR)/bin
	$(INSTALL) bin/runtimeSystemGCProf.o $(INSTDIR)/bin
	$(INSTALL) bin/runtimeSystemProf.o $(INSTDIR)/bin
	$(INSTALL) bin/rp2ps $(INSTDIR)/bin
	$(INSTALL) src/run $(INSTDIR)/bin/mlkit
	echo -e '#!/bin/sh' >> $(INSTDIR)/bin/kit
	echo -e '$(INSTDIR)/bin/mlkit $(KIT_FLAGS) $(INSTDIR) $$*'
	$(INSTALL) bin/kittester.$(ARCH-OS) $(INSTDIR)/bin
	echo -e 'sml @SMLload=$(INSTDIR)/bin/kittester.$(ARCH-OS) $$*' >> $(INSTDIR)/bin/kittester
	chmod a+x $(INSTDIR)/bin/kittester
	$(INSTALL) copyright $(INSTDIR)
	$(INSTALL) README $(INSTDIR)
	$(INSTALL) -a kitdemo $(INSTDIR)/kitdemo 
	$(INSTALL) -a test $(INSTDIR)/test
	$(INSTALL) -a src $(INSTDIR)/src
	cd $(INSTDIR)/src; make clean
	$(INSTALL) -a ml-yacc-lib $(INSTDIR)/ml-yacc-lib
	$(INSTALL) -a basislib $(INSTDIR)/basislib
	chown -R `whoami`.`whoami` $(INSTDIR)
	chmod -R ug+rw $(INSTDIR)
	chmod -R o+r $(INSTDIR)
	chmod a+x $(INSTDIR)/bin/mlkit

all_test:
	cd test; ../bin/kittester ../bin/kit all.tst

all: all_test bootstrap
